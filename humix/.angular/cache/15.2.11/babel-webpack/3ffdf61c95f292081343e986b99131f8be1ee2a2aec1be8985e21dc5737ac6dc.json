{"ast":null,"code":"import { of } from 'rxjs';\nimport { map, switchMap } from 'rxjs/operators';\nimport { catchError } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./iot.service\";\nimport * as i2 from \"./alerta.service\";\nexport let GravedadService = /*#__PURE__*/(() => {\n  class GravedadService {\n    constructor(iot, alertService) {\n      this.iot = iot;\n      this.alertService = alertService;\n    }\n    evaluarHumedad() {\n      // 1Ô∏è‚É£ Obtener humedad m√°xima √∫ltimas 48h\n      return this.iot.getBiggest2Day().pipe(switchMap(data => {\n        const hum = data.humedad;\n        // 2Ô∏è‚É£ Obtener conductividad m√°xima hoy\n        return this.iot.getMaxConductividadHoy().pipe(switchMap(dataCond => {\n          const cond = dataCond.conductividad;\n          // 3Ô∏è‚É£ Obtener logs √∫ltimas 24h\n          return this.iot.getLogsUltimas24H().pipe(map(logs => {\n            const umbral = 70;\n            const intervaloMin = 5;\n            const horas_alta = logs.filter(r => r.humedad > umbral).length * intervaloMin / 60;\n            // 4Ô∏è‚É£ Calcular score y gravedad\n            let score = 0;\n            if (hum > 70) {\n              score += 2;\n              this.iot.setDeshumidificador('on').pipe(catchError(err => {\n                console.error('Error al encender deshumidificador', err);\n                return of(null);\n              })).subscribe();\n            } else {\n              this.iot.setDeshumidificador('off').pipe(catchError(err => {\n                console.error('Error al apagar deshumidificador', err);\n                return of(null);\n              })).subscribe();\n            }\n            if (cond > 300) score += 1;\n            if (horas_alta > 6) score += 2;\n            const gravedad = score >= 4 ? 'alta' : score >= 2 ? 'media' : 'baja';\n            // 5Ô∏è‚É£ Enviar alerta con mensaje m√°s amigable seg√∫n gravedad\n            let mensaje = '';\n            switch (gravedad) {\n              case 'alta':\n                mensaje = `üî• ALERTA: Humedad muy alta (${hum}%) y conductividad (${cond}) ‚Äî Deshumidificador activado!`;\n                break;\n              case 'media':\n                mensaje = `‚ö†Ô∏è Atenci√≥n: Humedad moderada (${hum}%) y conductividad (${cond})`;\n                break;\n              case 'baja':\n                mensaje = `‚úÖ Todo en orden: Humedad (${hum}%), Conductividad (${cond}) baja`;\n                break;\n            }\n            this.alertService.enviar(mensaje);\n            return {\n              gravedad,\n              score\n            };\n          }));\n        }));\n      }));\n    }\n    static {\n      this.…µfac = function GravedadService_Factory(t) {\n        return new (t || GravedadService)(i0.…µ…µinject(i1.IotService), i0.…µ…µinject(i2.AlertaService));\n      };\n    }\n    static {\n      this.…µprov = /*@__PURE__*/i0.…µ…µdefineInjectable({\n        token: GravedadService,\n        factory: GravedadService.…µfac,\n        providedIn: 'root'\n      });\n    }\n  }\n  return GravedadService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}