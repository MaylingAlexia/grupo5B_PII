{"ast":null,"code":"import { of } from 'rxjs';\nimport { map, switchMap } from 'rxjs/operators';\nimport { catchError } from 'rxjs/operators';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./iot.service\";\nimport * as i2 from \"./alerta.service\";\nexport class GravedadService {\n  constructor(iot, alertService) {\n    this.iot = iot;\n    this.alertService = alertService;\n  }\n  evaluarHumedad() {\n    // 1️⃣ Obtener humedad máxima últimas 48h\n    return this.iot.getBiggest2Day().pipe(switchMap(data => {\n      const hum = data.humedad;\n      // 2️⃣ Obtener conductividad máxima hoy\n      return this.iot.getMaxConductividadHoy().pipe(switchMap(dataCond => {\n        const cond = dataCond.conductividad;\n        // 3️⃣ Obtener logs últimas 24h\n        return this.iot.getLogsUltimas24H().pipe(map(logs => {\n          const umbral = 70;\n          const intervaloMin = 5;\n          const horas_alta = logs.filter(r => r.humedad > umbral).length * intervaloMin / 60;\n          // 4️⃣ Calcular score y gravedad\n          let score = 0;\n          if (hum > 70) {\n            score += 2;\n            this.iot.setDeshumidificador('on').pipe(catchError(err => {\n              console.error('Error al encender deshumidificador', err);\n              return of(null); // evita que se rompa la cadena\n            })).subscribe();\n          } else {\n            this.iot.setDeshumidificador('off').pipe(catchError(err => {\n              console.error('Error al apagar deshumidificador', err);\n              return of(null);\n            })).subscribe();\n          }\n          if (cond > 300) score += 1;\n          if (horas_alta > 6) score += 2;\n          const gravedad = score >= 4 ? 'alta' : score >= 2 ? 'media' : 'baja';\n          // 5️⃣ Enviar alerta\n          this.alertService.enviar(`Score: ${score}, Gravedad: ${gravedad}`);\n          return {\n            gravedad,\n            score\n          };\n        }));\n      }));\n    }));\n  }\n  static {\n    this.ɵfac = function GravedadService_Factory(t) {\n      return new (t || GravedadService)(i0.ɵɵinject(i1.IotService), i0.ɵɵinject(i2.AlertaService));\n    };\n  }\n  static {\n    this.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: GravedadService,\n      factory: GravedadService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n}","map":{"version":3,"mappings":"AAGA,SAAqBA,EAAE,QAAQ,MAAM;AACrC,SAASC,GAAG,EAAEC,SAAS,QAAQ,gBAAgB;AAC/C,SAASC,UAAU,QAAQ,gBAAgB;;;;AAK3C,OAAM,MAAOC,eAAe;EAE1BC,YACUC,GAAe,EACfC,YAA2B;IAD3B,QAAG,GAAHD,GAAG;IACH,iBAAY,GAAZC,YAAY;EACnB;EAEHC,cAAc;IAEZ;IACA,OAAO,IAAI,CAACF,GAAG,CAACG,cAAc,EAAE,CAACC,IAAI,CACnCR,SAAS,CAAES,IAAS,IAAI;MACtB,MAAMC,GAAG,GAAGD,IAAI,CAACE,OAAO;MAExB;MACA,OAAO,IAAI,CAACP,GAAG,CAACQ,sBAAsB,EAAE,CAACJ,IAAI,CAC3CR,SAAS,CAAEa,QAAa,IAAI;QAC1B,MAAMC,IAAI,GAAGD,QAAQ,CAACE,aAAa;QAEnC;QACA,OAAO,IAAI,CAACX,GAAG,CAACY,iBAAiB,EAAE,CAACR,IAAI,CACtCT,GAAG,CAAEkB,IAAW,IAAI;UAClB,MAAMC,MAAM,GAAG,EAAE;UACjB,MAAMC,YAAY,GAAG,CAAC;UACtB,MAAMC,UAAU,GAAGH,IAAI,CAACI,MAAM,CAACC,CAAC,IAAIA,CAAC,CAACX,OAAO,GAAGO,MAAM,CAAC,CAACK,MAAM,GAAGJ,YAAY,GAAG,EAAE;UAElF;UACA,IAAIK,KAAK,GAAG,CAAC;UAEb,IAAId,GAAG,GAAG,EAAE,EAAE;YACZc,KAAK,IAAI,CAAC;YACV,IAAI,CAACpB,GAAG,CAACqB,mBAAmB,CAAC,IAAI,CAAC,CAC/BjB,IAAI,CAACP,UAAU,CAACyB,GAAG,IAAG;cACrBC,OAAO,CAACC,KAAK,CAAC,oCAAoC,EAAEF,GAAG,CAAC;cACxD,OAAO5B,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC;YACnB,CAAC,CAAC,CAAC,CACF+B,SAAS,EAAE;WACf,MAAM;YACL,IAAI,CAACzB,GAAG,CAACqB,mBAAmB,CAAC,KAAK,CAAC,CAChCjB,IAAI,CAACP,UAAU,CAACyB,GAAG,IAAG;cACrBC,OAAO,CAACC,KAAK,CAAC,kCAAkC,EAAEF,GAAG,CAAC;cACtD,OAAO5B,EAAE,CAAC,IAAI,CAAC;YACjB,CAAC,CAAC,CAAC,CACF+B,SAAS,EAAE;;UAGhB,IAAIf,IAAI,GAAG,GAAG,EAAEU,KAAK,IAAI,CAAC;UAC1B,IAAIJ,UAAU,GAAG,CAAC,EAAEI,KAAK,IAAI,CAAC;UAE9B,MAAMM,QAAQ,GACZN,KAAK,IAAI,CAAC,GAAG,MAAM,GACnBA,KAAK,IAAI,CAAC,GAAG,OAAO,GAAG,MAAM;UAE/B;UACA,IAAI,CAACnB,YAAY,CAAC0B,MAAM,CAAC,UAAUP,KAAK,eAAeM,QAAQ,EAAE,CAAC;UAElE,OAAO;YAAEA,QAAQ;YAAEN;UAAK,CAAE;QAC5B,CAAC,CAAC,CACH;MACH,CAAC,CAAC,CACH;IACH,CAAC,CAAC,CACH;EACH;;;uBA/DWtB,eAAe;IAAA;EAAA;;;aAAfA,eAAe;MAAA8B,SAAf9B,eAAe;MAAA+B,YAFd;IAAM;EAAA","names":["of","map","switchMap","catchError","GravedadService","constructor","iot","alertService","evaluarHumedad","getBiggest2Day","pipe","data","hum","humedad","getMaxConductividadHoy","dataCond","cond","conductividad","getLogsUltimas24H","logs","umbral","intervaloMin","horas_alta","filter","r","length","score","setDeshumidificador","err","console","error","subscribe","gravedad","enviar","factory","providedIn"],"sourceRoot":"","sources":["C:\\Users\\manav\\Desktop\\Lenguajes\\Python\\RaspberryPi\\humix\\src\\app\\services\\gravedad.service.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\nimport { IotService } from './iot.service';\nimport { AlertaService } from './alerta.service';\nimport { Observable, of } from 'rxjs';\nimport { map, switchMap } from 'rxjs/operators';\nimport { catchError } from 'rxjs/operators';\n\n@Injectable({\n  providedIn: 'root'\n})\nexport class GravedadService {\n\n  constructor(\n    private iot: IotService,\n    private alertService: AlertaService\n  ) {}\n\n  evaluarHumedad(): Observable<{ gravedad: string, score: number }> {\n\n    // 1️⃣ Obtener humedad máxima últimas 48h\n    return this.iot.getBiggest2Day().pipe(\n      switchMap((data: any) => {\n        const hum = data.humedad;\n\n        // 2️⃣ Obtener conductividad máxima hoy\n        return this.iot.getMaxConductividadHoy().pipe(\n          switchMap((dataCond: any) => {\n            const cond = dataCond.conductividad;\n\n            // 3️⃣ Obtener logs últimas 24h\n            return this.iot.getLogsUltimas24H().pipe(\n              map((logs: any[]) => {\n                const umbral = 70;\n                const intervaloMin = 5;\n                const horas_alta = logs.filter(r => r.humedad > umbral).length * intervaloMin / 60;\n\n                // 4️⃣ Calcular score y gravedad\n                let score = 0;\n\n                if (hum > 70) {\n                  score += 2;\n                  this.iot.setDeshumidificador('on')\n                    .pipe(catchError(err => {\n                      console.error('Error al encender deshumidificador', err);\n                      return of(null); // evita que se rompa la cadena\n                    }))\n                    .subscribe();\n                } else {\n                  this.iot.setDeshumidificador('off')\n                    .pipe(catchError(err => {\n                      console.error('Error al apagar deshumidificador', err);\n                      return of(null);\n                    }))\n                    .subscribe();\n                }\n\n                if (cond > 300) score += 1;\n                if (horas_alta > 6) score += 2;\n\n                const gravedad =\n                  score >= 4 ? 'alta' :\n                  score >= 2 ? 'media' : 'baja';\n\n                // 5️⃣ Enviar alerta\n                this.alertService.enviar(`Score: ${score}, Gravedad: ${gravedad}`);\n\n                return { gravedad, score };\n              })\n            );\n          })\n        );\n      })\n    );\n  }\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}